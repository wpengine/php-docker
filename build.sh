#!/bin/bash

# setting default version to 7.1
VERSION=${1:-7.1}
BASE_IMAGE=${2:-alpine}

# usage: build.sh < 5.6 | 7.0 | 7.1 > < alpine | busybox >
case $VERSION in
5.6)
  PHP_VERSION=5.6.31
  GPG_KEY1=0BD78B5F97500D450838F95DFE857D9A90D90EC1
  GPG_KEY2=6E4F6AB321FDC07F2C332E3AC2BF0BC433CFC8B3
  PHP_SHA256=c464af61240a9b7729fabe0314cdbdd5a000a4f0c9bd201f89f8628732fe4ae4
  PHP_EXT_SUFFIX=20131226
  ;;
7.0)
  PHP_VERSION=7.0.22
  GPG_KEY1=1A4E8B7277C42E53DBA9C7B9BCAA30EA9C0D5763
  GPG_KEY2=6E4F6AB321FDC07F2C332E3AC2BF0BC433CFC8B3
  PHP_SHA256=408c3fbc235ec940433bfac1f3ed4bf797f61b4a1693b9fb0b6a04b2c1832501
  PHP_EXT_SUFFIX=20151012
  ;;
7.1)
  PHP_VERSION=7.1.7
  GPG_KEY1=A917B1ECDA84AEC2B568FED6F50ABC807BD5DCD0
  GPG_KEY2=528995BFEDFBA7191D46839EF9BA0ADA31CBD89E
  PHP_SHA256=0d42089729be7b2bb0308cbe189c2782f9cb4b07078c8a235495be5874fff729
  PHP_EXT_SUFFIX=20160303
  ;;
esac

echo Building $PHP_VERSION $BASE_IMAGE
if [ $BASE_IMAGE = "busybox" ]; then
    DOCKERFILE_EXT=php.$BASE_IMAGE
else
    DOCKERFILE_EXT=php$VERSION.$BASE_IMAGE
fi;

docker build -t wpengine/php:$VERSION-$BASE_IMAGE -f Dockerfile.$DOCKERFILE_EXT . \
    --build-arg PHP_VERSION=$PHP_VERSION --build-arg VERSION=$VERSION \
    --build-arg PHP_SHA256=$PHP_SHA256 --build-arg GPG_KEY1=$GPG_KEY1 \
    --build-arg GPG_KEY2=$GPG_KEY2 --build-arg PHP_EXT_SUFFIX=$PHP_EXT_SUFFIX;